<!doctype html>
<html style="width: 100%; height: 100%; margin: 0px;">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta name="widget-description" content =  'This is a JSON to table widget. It will display JSON-data of the datapoint linked to STATE or LEVEL as a table.<br>
												Example JSON: [{"Col 1": "My Value in row 1", "Col two": "My Value two"}, {"Col 1": "My Value in row 2", "Col two": "Another val"}]<br> 
												<br>
												You can customize <b>display modes</b> of the table, <b>sorting</b> and <b>filter</b> of columns and <b>translations</b>.<br>
												<br>
												By setting <b>icon-replacements</b> you can define values, that will be replaced by icons. This way you could for example replace the values "true" and "false" by corresponding icons.<br>
												<br>
												With the <b>Datapoint-Detection</b> you can specify a column, in which the widget will look for ioBroker-Datapoints. 
												Then you can set several attributes of the datapoint by which the table will be <b>extended</b>. Possible values are: 
												<ul style="padding-left:20px;"><li style="list-style-type: disc;">val (value rounded), </li><li style="list-style-type: disc;">unit, </li><li style="list-style-type: disc;">valFull: (value not rounded, no javascript-injection prevention), </li><li style="list-style-type: disc;">plainText (clear text of val, for example taken from valuelist), </li><li style="list-style-type: disc;">min, </li><li style="list-style-type: disc;">max, </li><li style="list-style-type: disc;">step (step-width), </li><li style="list-style-type: disc;">valuelist (object with possible values and corresponding clear text), </li><li style="list-style-type: disc;">targetValues, </li><li style="list-style-type: disc;">ack, </li><li style="list-style-type: disc;">readonly, </li><li style="list-style-type: disc;">custom: (object with custom settings), </li><li style="list-style-type: disc;">id, </li><li style="list-style-type: disc;">from, </li><li style="list-style-type: disc;">lc (last change), </li><li style="list-style-type: disc;">ts (last actualized), </li><li style="list-style-type: disc;">q (quality), </li><li style="list-style-type: disc;">role, </li><li style="list-style-type: disc;">type, </li><li style="list-style-type: disc;">name, </li><li style="list-style-type: disc;">parentName (name of the next superior datapoint), </li><li style="list-style-type: disc;">desc</li></ul><br>
												<br>
												You can also specify a <b>language</b> these attributes are automatically translated to.<br>
												<br>
												Then you can define cols in which <b>toggling</b> of the datapoint is enabled.<br>
												<br>
												(C) by Sebastian Bormann
	'/> 
	<meta name="widget-urlparameters" content= "tableMode/columntoggle/Table Mode (mode how small screens are handled)/select/columntoggle,Hide columns as needed/reflow,Display the table stacked/none,Keep table as it is;
												colsSort//Order of headings (semioclon-separated list of column headers, optional);
												colsFilter//Filter these headings (semicolon-separated list of column headers, optional);
												translations//Translations (semicolon-separated list of comma-separated translations, for example filesize,Size of file);
												useThisDatapoint//Use this Datapoint (if empty, the default Datapoint (e.g. the Datapoint defined in STATE of this device) will be used)/datapoint;
												//Settings for Table Mode 'Hide columns as needed'/section;
												breakpoints/20%3B30%3B40%3B50%3B60%3B70%3B80/Breakpoints (semicolon-separated list of screen-widths in em, at which the next column is shown);
												colsAlwaysVisible//Always visible headings, that can't be hidden (semicolon-separated list of column headers, optional);
												colsPreferablyVisible//Preferably visible headings in descending priority (semicolon-separated list of column headers, optional);
												colsPreferablyVisibleAreVisibleAtStart/false/Preferably visible headings are always visible at start (no matter which screen size), but can be hidden via menu /checkbox;
												headHideColumntoggleButton/false/Hide column-toggle-button in table mode 'Hide columns as needed'/checkbox;
												//Modification of Data/section;
												dataTranspose/false/Transpose data (switch cols and rows)/checkbox;
												dataTransposeKeycolCaption/Key/Caption of the first column, that contains all the previos column-headers/text;
												dataTransposeValcolsPrefix/Value /Prefix for caption of all the other columns, that contain the values/text;
												//Styling/section;
												rowsLimit//Load only this number of rows (0 = no limit)/number/0,1000,1;
												rowsLimitLoadMore/true/Show 'Load more' button/checkbox;
												rowsLimitLoadMoreCaption/.../Caption of 'Load more' Button/text;
												headHide/false/Hide Head of table/checkbox;
												scrollbarHide/false/Hide Scrollbar (may not work in all browsers)/checkbox;
												//Icon-Replacement/section;
												iconCols//Search for strings and replace with icons in these headings (semicolon-separated list of column headers, optional);
												icon1Url//Icon 1/icon;icon1Caption//Caption that will be added to icon 1;icon1String//String that will be replaced by icon 1;///divider;
												icon2Url//Icon 2/icon;icon2Caption//Caption that will be added to icon 2;icon2String//String that will be replaced by icon 2;///divider;
												icon3Url//Icon 3/icon;icon3Caption//Caption that will be added to icon 3;icon3String//String that will be replaced by icon 3;///divider;
												icon4Url//Icon 4/icon;icon4Caption//Caption that will be added to icon 4;icon4String//String that will be replaced by icon 4;///divider;
												icon5Url//Icon 5/icon;icon5Caption//Caption that will be added to icon 5;icon5String//String that will be replaced by icon 5;///divider;
												icon6Url//Icon 6/icon;icon6Caption//Caption that will be added to icon 6;icon6String//String that will be replaced by icon 6;///divider;
												icon7Url//Icon 7/icon;icon7Caption//Caption that will be added to icon 7;icon7String//String that will be replaced by icon 7;///divider;
												icon8Url//Icon 8/icon;icon8Caption//Caption that will be added to icon 8;icon8String//String that will be replaced by icon 8;///divider;
												icon9Url//Icon 9/icon;icon9Caption//Caption that will be added to icon 9;icon9String//String that will be replaced by icon 9;///divider;
												icon10Url//Icon 10/icon;icon10Caption//Caption that will be added to icon 10;icon10String//String that will be replaced by icon 10;///divider;
												icon11Url//Icon 11/icon;icon11Caption//Caption that will be added to icon 11;icon11String//String that will be replaced by icon 11;///divider;
												icon12Url//Icon 12/icon;icon12Caption//Caption that will be added to icon 12;icon12String//String that will be replaced by icon 12;
												//Datapoint Detection/section;
												datapointDetectionEnabled/true/Enable datapoint detection/checkbox;
												datapointIdCol/id/Search for datapoint ids in this column (column header);
												datapointIdColFilter/true/Add the datapoint id column to the 'Filter these headings' list/checkbox;
												datapointExtendTableCols/parentName%3BplainText/Add these columns with attributes of the datapoint to the table (semicolon-separated list of attributes, see info text above, - for none);
												datapointExtendTableColsDefaultTranslationLanguage/en/Add standard translations for these columns/select/,None/en,Englisch/de,German/ru,Russian/pt,Polish/nl,Dutch/fr,French/it,Italian/es,Spanish/zh-cn,Chinese;
												datapointToggleCols/plainText/Enable toggling of the datapoint in this columns (semicolon-separated list with column headers, - for none);
	">
	<meta name="widget-options" content="{'noZoomOnHover': 'true', 'hideDeviceName': 'true', 'sizeInactive': 'xwideIfInactive highIfInactive', 'iconNoPointerEventsInactive': 'true', 'noOverlayInactive': 'true', 'hideDeviceNameIfInactive': 'true', 'hideStateIfInactive': 'true', 'sizeActive': 'xwideIfActive highIfActive', 'bigIconActive': 'false', 'iconNoPointerEventsActive': 'true', 'noOverlayActive': 'true', 'hideDeviceNameIfActive': 'true', 'hideStateIfActive': 'true', 'iconNoPointerEventsEnlarged': 'true', 'noOverlayEnlarged': 'true', 'hideDeviceNameIfEnlarged': 'true', 'hideStateIfEnlarged': 'true', 'sizeEnlarged': 'fullWidthIfEnlarged fullHeightIfEnlarged', 'bigIconEnlarged': 'true', 'popupAllowPostMessage': 'true', 'backgroundURLAllowPostMessage': 'true', 'backgroundURLNoPointerEvents': 'false', 'tileEnlargeShowButtonInactive': 'true', 'tileEnlargeShowButtonActive': 'true', 'tileEnlargeShowInPressureMenuInactive': 'true', 'tileEnlargeShowInPressureMenuActive': 'true'}"/>
 
	<link rel="stylesheet" href="/iqontrol/jquery/jquery.mobile-1.4.5.min.css"/>
	<script type="text/javascript" src="/iqontrol/jquery/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/iqontrol/jquery/jquery.mobile-1.4.5.min.js"></script>
	<!--script type="text/javascript" src="/iqontrol/../../lib/js/translate.js"></script-->
	<style>
		::-webkit-scrollbar {
		  width: 5px;
		  height: 5px;
		}
		::-webkit-scrollbar-track {
		  background: #eee;
		}
		::-webkit-scrollbar-thumb {
		  background: #aaa; 
		}
		::-webkit-scrollbar-thumb:hover {
		  background: #888; 
		}
		document {
			overflow: hidden !important;
			overscroll-behavior: contain !important;
			background: transparent !important;
		}
		html {
			overflow-y: scroll !important;
			overflow-x: hidden !important;
			overscroll-behavior: contain !important;
			background: transparent !important;
			-webkit-transition: all 1s;
			   -moz-transition: all 1s;
					transition: all 1s;
		}
		.ui-page {
			overscroll-behavior: contain !important;
			background: transparent !important;
			-webkit-user-select: none !important;
			   -moz-user-select: none !important; 
					user-select: none !important;
			-webkit-touch-callout: none !important;
			overflow: visible !important;
			min-height: unset !important;
			height: 100% !important;
			margin: 0;
			padding: 0;
		}
		.ui-content {
			margin: 0;
			padding: 0;
		}
		.ui-table-columntoggle-btn {
			border: none !important;
			box-shadow: none !important;
			padding: 9px 20px 8px 20px !important;
			background: transparent !important;
			position: absolute !important;
			top: -8px !important;
			right: -8px !important;
			font-weight: 900 !important;
		}
		.ui-table-columntoggle-btn:hover {
			background: rgba(0,0,0,0.1) !important;
		}
		thead tr td {
			white-space: nowrap;
		}
		.jsonTableIcon {
			width: 24px;
			height: 24px;
			border: 0;
			margin: -3px 0px -8px 0px;
		}
		html.color-mode-dark .ui-overlay-a, html.color-mode-dark .ui-page-theme-a, html.color-mode-dark .ui-page-theme-a .ui-panel-wrapper {
			background-color: #454545;
			color: #b9b9b9;
			text-shadow: 0 1px 0 #3c3c3c
		}
		html.color-mode-dark .table-stripe tbody tr:nth-child(odd) td, html.color-mode-dark .table-stripe tbody tr:nth-child(odd) th {
			background-color: #555555;
		}
	</style>
	<title>iQontrol JSON to TABLE Widget</title>
</head>
<body style="width: 100%; height: 100%; margin: 0; overflow: auto;">
	<div data-role="page">
		<div data-role="content">
			<div id="jsonTableContainer" style="width: 100%; height: 100%; overflow: auto;"></div>
			<div id="loadMoreButtonContainer" style="display: none; padding: 0px; margin: -7px -10px -5px -10px;"><a href="" data-role="button" data-mini="true" id="loadMoreButton" style="height: 1.3em;">...</a></div>
		</div>
	</div>
	<script type="text/javascript">
		//Declarations
		var USE_THIS_DATAPOINT;
		var STATE;
		var LEVEL;
		var options;
		var lastColsSortedAndFilteredStringified;
		var breakpointsCount = -1;
		var datapointRegex = new RegExp('.*\.[0-9]+\..*');
		var datapoints = {};
		var datapointsParentNames = {};
		var tableDatapoints = {};
		var datapointExtendTableColsDefaultTranslationWords = {
		  "val": {
			"en": "Value",
			"de": "Wert",
			"ru": "Ценить",
			"pt": "Valor",
			"nl": "Waarde",
			"fr": "Valeur",
			"it": "Valore",
			"es": "Valor",
			"pl": "Wartość",
			"zh-cn": "价值"
		  },
		  "unit": {
			"en": "Unit",
			"de": "Einheit",
			"ru": "Ед. изм",
			"pt": "Unidade",
			"nl": "Eenheid",
			"fr": "Unité",
			"it": "Unità",
			"es": "Unidad",
			"pl": "Jednostka",
			"zh-cn": "单元"
		  },
		  "valFull": {
			"en": "Complete Value",
			"de": "Vollständiger Wert",
			"ru": "Полная ценность",
			"pt": "Valor Completo",
			"nl": "Volledige waarde",
			"fr": "Valeur complète",
			"it": "Valore completo",
			"es": "Valor completo",
			"pl": "Pełna wartość",
			"zh-cn": "完整的价值"
		  },
		  "plainText": {
			"en": "Status",
			"de": "Status",
			"ru": "Положение дел",
			"pt": "Status",
			"nl": "Toestand",
			"fr": "Statut",
			"it": "Stato",
			"es": "Estado",
			"pl": "Status",
			"zh-cn": "地位"
		  },
		  "min": {
			"en": "Minimum",
			"de": "Minimum",
			"ru": "Минимум",
			"pt": "Mínimo",
			"nl": "Minimum",
			"fr": "Le minimum",
			"it": "Minimo",
			"es": "Mínimo",
			"pl": "Minimum",
			"zh-cn": "最低限度"
		  },
		  "max": {
			"en": "Maximum",
			"de": "Maximum",
			"ru": "Максимум",
			"pt": "Máximo",
			"nl": "Maximaal",
			"fr": "Maximum",
			"it": "Massimo",
			"es": "Máximo",
			"pl": "Maksymalny",
			"zh-cn": "最大值"
		  },
		  "step": {
			"en": "Step Width",
			"de": "Schrittweite",
			"ru": "Ширина шага",
			"pt": "Largura do Passo",
			"nl": "Stapbreedte",
			"fr": "Largeur de pas",
			"it": "Larghezza passo",
			"es": "Ancho de paso",
			"pl": "Szerokość kroku",
			"zh-cn": "步宽"
		  },
		  "valueList": {
			"en": "Value List",
			"de": "Werteliste",
			"ru": "Список значений",
			"pt": "Lista de Valores",
			"nl": "Waardelijst",
			"fr": "Liste de valeurs",
			"it": "Lista valori",
			"es": "Lista de valores",
			"pl": "Lista wartości",
			"zh-cn": "值列表"
		  },
		  "targetValues": {
			"en": "Target Values",
			"de": "Zielwerte",
			"ru": "Целевые значения",
			"pt": "Valores Alvo",
			"nl": "Doelwaarden",
			"fr": "Valeurs cibles",
			"it": "Valori target",
			"es": "Valores objetivo",
			"pl": "Wartości docelowe",
			"zh-cn": "目标值"
		  },
		  "ack": {
			"en": "Acknowledged",
			"de": "Anerkannt",
			"ru": "Признано",
			"pt": "Reconhecido",
			"nl": "Erkend",
			"fr": "Reconnu",
			"it": "Riconosciuto",
			"es": "Admitido",
			"pl": "Potwierdzony",
			"zh-cn": "确认"
		  },
		  "readonly": {
			"en": "Readonly",
			"de": "Schreibgeschützt",
			"ru": "Только чтение",
			"pt": "Somente leitura",
			"nl": "Alleen lezen",
			"fr": "Lecture seulement",
			"it": "Sola lettura",
			"es": "Solo lectura",
			"pl": "Tylko czytać",
			"zh-cn": "只读"
		  },
		  "custom": {
			"en": "Custom",
			"de": "Benutzerdefiniert",
			"ru": "Обычай",
			"pt": "Personalizado",
			"nl": "Aangepast",
			"fr": "Personnalisé",
			"it": "Costume",
			"es": "Personalizado",
			"pl": "Zwyczaj",
			"zh-cn": "风俗"
		  },
		  "id": {
			"en": "Datapoint",
			"de": "Datenpunkt",
			"ru": "Datapoint",
			"pt": "Datapoint",
			"nl": "Data punt",
			"fr": "Point de données",
			"it": "Datapoint",
			"es": "Punto de datos",
			"pl": "Punkt danych",
			"zh-cn": "数据点"
		  },
		  "from": {
			"en": "From",
			"de": "Von",
			"ru": "Из",
			"pt": "A partir de",
			"nl": "Van",
			"fr": "De",
			"it": "A partire dal",
			"es": "De",
			"pl": "Z",
			"zh-cn": "从"
		  },
		  "lc": {
			"en": "Last Change",
			"de": "Letzte Änderung",
			"ru": "Последнее изменение",
			"pt": "Última mudança",
			"nl": "Laatste wijziging",
			"fr": "Dernier changement",
			"it": "Ultima modifica",
			"es": "Ultimo cambio",
			"pl": "Ostatnia zmiana",
			"zh-cn": "最后一次变更"
		  },
		  "ts": {
			"en": "Timestamp",
			"de": "Zeitstempel",
			"ru": "Отметка времени",
			"pt": "Timestamp",
			"nl": "Tijdstempel",
			"fr": "Horodatage",
			"it": "Timestamp",
			"es": "Marca de tiempo",
			"pl": "Znak czasu",
			"zh-cn": "时间戳"
		  },
		  "q": {
			"en": "Quality",
			"de": "Qualität",
			"ru": "Качественный",
			"pt": "Qualidade",
			"nl": "Kwaliteit",
			"fr": "Qualité",
			"it": "Qualità",
			"es": "Calidad",
			"pl": "Jakość",
			"zh-cn": "质量"
		  },
		  "role": {
			"en": "Role",
			"de": "Rolle",
			"ru": "Роль",
			"pt": "Função",
			"nl": "Rol",
			"fr": "Rôle",
			"it": "Ruolo",
			"es": "Papel",
			"pl": "Rola",
			"zh-cn": "角色"
		  },
		  "type": {
			"en": "Type",
			"de": "Typ",
			"ru": "Тип",
			"pt": "Modelo",
			"nl": "Type",
			"fr": "Taper",
			"it": "Tipo",
			"es": "Escribe",
			"pl": "Rodzaj",
			"zh-cn": "类型"
		  },
		  "name": {
			"en": "Name",
			"de": "Name",
			"ru": "Имя",
			"pt": "Nome",
			"nl": "Naam",
			"fr": "Nom",
			"it": "Nome",
			"es": "Nombre",
			"pl": "Nazwa",
			"zh-cn": "姓名"
		  },
		  "parentName":  {
			"en": "Device Name",
			"de": "Gerätename",
			"ru": "Имя устройства",
			"pt": "Nome do dispositivo",
			"nl": "Toestelnaam",
			"fr": "Nom de l'appareil",
			"it": "Nome del dispositivo",
			"es": "Nombre del dispositivo",
			"pl": "Nazwa urządzenia",
			"zh-cn": "设备名称"
		  },
		  "desc": {
			"en": "Description",
			"de": "Beschreibung",
			"ru": "Описание",
			"pt": "Descrição",
			"nl": "Beschrijving",
			"fr": "La description",
			"it": "Descrizione",
			"es": "Descripción",
			"pl": "Opis",
			"zh-cn": "描述"
		  },
		  "deviceName": {
			"en": "Device Name",
			"de": "Gerätename",
			"ru": "Имя устройства",
			"pt": "Nome do dispositivo",
			"nl": "Toestelnaam",
			"fr": "Nom de l'appareil",
			"it": "Nome del dispositivo",
			"es": "Nombre del dispositivo",
			"pl": "Nazwa urządzenia",
			"zh-cn": "设备名称"
		  }
		};

		//UrlParameters
		var tableMode = getUrlParameter("tableMode") || "columntoggle";
		var colsSort = (getUrlParameter("colsSort") || "").split(';');
		var colsFilter = (getUrlParameter("colsFilter") || "").split(';');
		var colsAlwaysVisible = (getUrlParameter("colsAlwaysVisible") || "").split(';');
		var colsPreferablyVisible = (getUrlParameter("colsPreferablyVisible") || "").split(';');
		var colsPreferablyVisibleAreVisibleAtStart = getUrlParameter("colsPreferablyVisibleAreVisibleAtStart") == "true";
		var breakpoints = (getUrlParameter("breakpoints") || "20;30;40;50;60;70").split(';');
		var translations = (getUrlParameter("translations") || "").split(';');
		var dataTranspose = (getUrlParameter("dataTranspose") == "true");
		var dataTransposeKeycolCaption = getUrlParameter("dataTransposeKeycolCaption") || "Key";
		var dataTransposeValcolsPrefix = getUrlParameter("dataTransposeValcolsPrefix") || "Value ";
		var rowsLimit = parseInt(getUrlParameter("rowsLimit") || "0") || 0;
		var rowsLimitLoadMore = !(getUrlParameter("rowsLimitLoadMore") == "false");
		var rowsLimitLoadMoreCaption = getUrlParameter("rowsLimitLoadMoreCaption") || "...";
		var headHide = getUrlParameter("headHide") == "true";
		var headHideColumntoggleButton = getUrlParameter("headHideColumntoggleButton") == "true";
		var scrollbarHide = getUrlParameter("scrollbarHide") == "true";
		for(var i = 0; i < translations.length; i++){
			let entry = translations[i].split(',');
			if (entry.length < 2) entry.push(entry[0]);
			translations[i] = {searchValue: entry[0], newValue: entry[1]};
		}
		var iconCols = (getUrlParameter("iconCols") || "").split(';');		
		var iconReplacements = [];
		for(var i = 1; i <= 12; i++){
			var iconUrl = getUrlParameter("icon" + i + "Url");
            if (iconUrl && iconUrl.indexOf('http') !== 0) iconUrl = '/iqontrol/' + iconUrl
			var caption = getUrlParameter("icon" + i + "Caption");
			var string = getUrlParameter("icon" + i + "String");
			if (iconUrl && string) iconReplacements.push({searchValue: string, newValue: "<img src='" + iconUrl + "' class='jsonTableIcon'>" + (caption ? "&nbsp;" + caption : "")});
		}
		var translationsAndIconReplacements = iconReplacements.concat(translations);
		var datapointDetectionEnabled = !(getUrlParameter("datapointDetectionEnabled") == "false");
		var datapointIdCol = getUrlParameter("datapointIdCol");
		datapointIdCol = (datapointIdCol ? datapointIdCol : "id");
		var datapointIdColFilter = !(getUrlParameter("datapointIdColFilter") == "false");
		if (datapointDetectionEnabled && datapointIdColFilter && datapointIdCol) colsFilter.push(datapointIdCol);
		var datapointExtendTableCols = (getUrlParameter("datapointExtendTableCols") || "parentName;plainText").split(';');
		var datapointExtendTableColsDefaultTranslationLanguage = getUrlParameter("datapointExtendTableColsDefaultTranslationLanguage");
		datapointExtendTableColsDefaultTranslationLanguage = (datapointExtendTableColsDefaultTranslationLanguage ? datapointExtendTableColsDefaultTranslationLanguage : "en");
		if (datapointExtendTableColsDefaultTranslationLanguage){
			for(word in datapointExtendTableColsDefaultTranslationWords){
				translations.push({searchValue: word, newValue: datapointExtendTableColsDefaultTranslationWords[word][datapointExtendTableColsDefaultTranslationLanguage]});
			}
		}
		var datapointToggleCols = (getUrlParameter("datapointToggleCols") || "plainText").split(';');

		//Document ready
		$(document).ready(function(){
			//Apply some styling
			$('#loadMoreButton').html(rowsLimitLoadMoreCaption);
			if(headHide) addCustomCSS('#jsonTable { margin-top: -2.3em; } @media (max-width: 35em) { #jsonTable.ui-table-reflow.ui-responsive { margin-top: 0 !important; } #jsonTable.ui-table-reflow.ui-responsive .ui-table-cell-label { display: none; } }', 'headHide');
			if(headHideColumntoggleButton) addCustomCSS('.ui-table-columntoggle-btn { display: none; }', 'headHideColumntoggleButton');
			if(scrollbarHide) addCustomCSS('::-webkit-scrollbar { display: none; }', 'scrollbarHide');
			//Subscribe to Datapoints
			console.log("Subscribe to Datapoints");
			sendPostMessage("getOptions");
			if (getUrlParameter("useThisDatapoint")) sendPostMessage("getStateSubscribed", getUrlParameter("useThisDatapoint")); else USE_THIS_DATAPOINT = null;
			sendPostMessage("getWidgetDeviceStateSubscribed", "STATE");
			sendPostMessage("getWidgetDeviceStateSubscribed", "LEVEL");
			//Enhance loadMoreButton
			$('#loadMoreButton').on('click', function(){
				rowsLimit += (parseInt(getUrlParameter("rowsLimit") || "0") || 0);
				console.log("New rowsLimit: " + rowsLimit);
				$('#jsonTable tbody tr:nth-child(-n+' + rowsLimit + ')').slideDown(500);
				if(dataObject.length <= rowsLimit){
					$('#loadMoreButtonContainer').hide(500);
				}				
			});
		});
		
		//Handle Options
		function handleOptions(){
			if (typeof options !== "object") return;
			//Dark-Mode
			switch(options.LayoutColorModeDarkEnable){
				case "disabled":
				break;

				case "always":
				applyColorMode('dark');
				break;
				
				default:
				if (window.matchMedia){
					var darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
					applyColorMode(darkMode ? 'dark' : '');
					window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', darkModeEventListenerFunction);
					window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', darkModeEventListenerFunction);
					function darkModeEventListenerFunction(e){
						darkMode = e.matches;
						applyColorMode(darkMode ? 'dark' : '');
					}
				}
			}
			function applyColorMode(colorMode){
				$("html").removeClass(function(index, className){
					return (className.match (/(^|\s)color-mode-\S+/g) || []).join(' ');
				});	
				if (colorMode && colorMode != "") $("html").addClass("color-mode-" + colorMode);
			}
		}
		
		//Create Table
		function createTable(){
			if (typeof USE_THIS_DATAPOINT == "undefined" || typeof STATE == "undefined" || typeof LEVEL == "undefined") return; //Only do this, if all necessary states are fetched
			var dp = USE_THIS_DATAPOINT || LEVEL || STATE || null;
			if (dp == null || typeof dp.val == "undefined" || dp.val == null || dp.val == "") return;
			dataObject = tryParseJSON(dp.val);
			console.log("parsed JSON");
			console.log(dataObject);
			//Transpose
			if(dataTranspose){
				var newDataObject = [];
				var keys = [];
				for (var row = 0; row < dataObject.length; row++) {
					for (var key in dataObject[row]) {
						if (keys.indexOf(key) === -1) {
							keys.push(key);
						}
					}
				}
				keys.forEach(function(key){
					var newRow = {};
					newRow[dataTransposeKeycolCaption] = key;
					for (var row = 0; row < dataObject.length; row++) {
						if (typeof dataObject[row][key] != "undefined") newRow[dataTransposeValcolsPrefix.toString() + (row + 1).toString()] = dataObject[row][key];
					}
					newDataObject.push(newRow);
				});
				dataObject = newDataObject;
				if(colsSort.indexOf(dataTransposeKeycolCaption) == -1) colsSort.unshift(dataTransposeKeycolCaption);
			}
			//Datapoint-Detection
			tableDatapoints = {};
			if (datapointDetectionEnabled && datapointIdCol){
				for (var row = 0; row < dataObject.length; row++) {
					var id = dataObject[row][datapointIdCol];
					if (datapointRegex.test(id)){ //Datapoint id found
						if (typeof tableDatapoints[id] == "undefined") tableDatapoints[id] = {rows: []};
						tableDatapoints[id].rows.push(row);
						//Extend Table
						datapointExtendTableCols.forEach(function(datapointExtendTableCol){
							if (typeof dataObject[row][datapointExtendTableCol] == "undefined") {
								dataObject[row][datapointExtendTableCol] = "";
								if (datapointExtendTableCol == "parentName"){ //parentName
									var parentId = id.substring(0, id.lastIndexOf("."));
									if (typeof datapointsParentNames[parentId] == "undefined") datapointsParentNames[parentId] = {childIds: []};
									datapointsParentNames[parentId].childIds.push(id);
									if (typeof tableDatapoints[parentId] == "undefined") tableDatapoints[parentId] = {rows: []};
								}
							}
						});
					}
				}
			}
			//Get cols
			var cols = [];
			for (var row = 0; row < dataObject.length; row++) {
				for (var key in dataObject[row]) {
					if (cols.indexOf(key) === -1) {
						cols.push(key);
					}
				}
			}
			//Sort cols
			var colsSorted = [];			
			for (var col = 0; col < colsSort.length; col++) {
				if (cols.indexOf(colsSort[col]) > -1) colsSorted.push(colsSort[col]);
			}
			for (var col = 0; col < cols.length; col++) { //add the remaining cols
				if (colsSorted.indexOf(cols[col]) == -1) colsSorted.push(cols[col]);
			}
			//Filter cols
			var colsSortedAndFiltered = [];
			for (var col = 0; col < colsSorted.length; col++) {
				if (colsFilter.indexOf(colsSorted[col]) == -1) colsSortedAndFiltered.push(colsSorted[col]);
			}
			//Add breakpoints
			createBreakpoints(colsSortedAndFiltered.length);
			//Build table and head
			var alwaysVisibleCount = 0;
			var preferablyVisibleCount = 0;
			var colsPreferablyVisibleTranslated = [];
			for (var col = 0; col < colsSortedAndFiltered.length; col++) {
				if (colsAlwaysVisible.indexOf(colsSortedAndFiltered[col]) != -1) alwaysVisibleCount++; //Counts how many cols are always Visible
				if (colsPreferablyVisible.indexOf(colsSortedAndFiltered[col]) != -1) preferablyVisibleCount++; //Counts how many cols are preferably Visible
			}
			var tableString = "<table id='jsonTable' data-role='table' data-mode='" + tableMode + "' class='jsonTable ui-responsive table-stroke table-stripe' data-column-btn-mini='true' data-column-btn-text='&#8942;' style='font-size: smaller;'>";
			tableString += "<thead>";
			tableString += "<tr>";
			var priorityPreferablyIndex = alwaysVisibleCount;
			var priorityNormalIndex = alwaysVisibleCount + preferablyVisibleCount;
			for (var col = 0; col < colsSortedAndFiltered.length; col++) {
				tableString += "<th data-priority='";
				if (col == 0 && alwaysVisibleCount == 0) { //col 0 is made alwaysVisible because no other alwaysVisible is defined
					priorityNormalIndex++;
					priorityPreferablyIndex++;
				} else {
					if (colsAlwaysVisible.indexOf(colsSortedAndFiltered[col]) == -1) { 
						if (colsPreferablyVisible.indexOf(colsSortedAndFiltered[col]) == -1) {
							tableString += priorityNormalIndex;
							priorityNormalIndex++;
						} else {
							tableString += colsPreferablyVisible.indexOf(colsSortedAndFiltered[col]) + priorityPreferablyIndex;
							colsPreferablyVisibleTranslated.push(multiReplace(colsSortedAndFiltered[col] || (col + 1).toString(), translations, true));
						}
					}
				}
				tableString += "'>" + multiReplace(colsSortedAndFiltered[col] || (col + 1).toString(), translations, true) + "</th>";
			}
			tableString += "</tr>";
			tableString += "</thead>";
			tableString += "<tbody>";
			tableString += "</tbody>";
			tableString += "</table>";
			//Build body
			var bodyString = "";
			for (var row = 0; row < dataObject.length; row++) {
				bodyString += "<tr data-row='" + row + "'" + (rowsLimit == 0 || row < rowsLimit ? "" : "style='display:none;'") + ">";
				for (var col = 0; col < colsSortedAndFiltered.length; col++) {
					bodyString += "<td data-row='" + row + "' data-colname='" + colsSortedAndFiltered[col] + "'>" + multiReplace(dataObject[row][colsSortedAndFiltered[col]] || "", ((iconCols[0] == "" || iconCols.indexOf(colsSortedAndFiltered[col]) != -1) ? translationsAndIconReplacements : translations), true) + "</td>";
				}
				bodyString += "</tr>";
			}
			//Append table
			if (JSON.stringify(colsSortedAndFiltered) != lastColsSortedAndFilteredStringified){ //New Headings (or first build of table) - completely rebuild table
				lastColsSortedAndFilteredStringified = JSON.stringify(colsSortedAndFiltered);
				//Save last manually colsHidden/Visible state
				var colsHidden = [];
				var colsVisible = [];
				var popupVisible = $('#jsonTable-popup-popup').hasClass('ui-popup-active');
				$('.jsonTable.ui-table-columntoggle th.ui-table-cell-hidden').each(function(){ colsHidden.push($(this).text()); })
				$('.jsonTable.ui-table-columntoggle th.ui-table-cell-visible').each(function(){ colsVisible.push($(this).text()); })
				//Completely rebuild table
				$('#jsonTable-popup-popup').remove();
				$('#jsonTableContainer').html(tableString);
				$('#jsonTableContainer tbody').html(bodyString);
				$('#jsonTable').table().trigger('create');
				//Restore last colsHidden/Visible state
				$('#jsonTable-popup label').each(function(){ 
					if (colsVisible.indexOf($(this).text()) != -1 || (colsPreferablyVisibleAreVisibleAtStart && colsPreferablyVisibleTranslated.indexOf($(this).text()) != -1)) {
						$(this).next('input[type=checkbox]').prop('checked',true).trigger('change').checkboxradio('refresh');
					} else if (colsHidden.indexOf($(this).text()) != -1) {
						$(this).next('input[type=checkbox]').prop('checked',false).trigger('change').checkboxradio('refresh');
					}
				});
				colsPreferablyVisibleAreVisibleAtStart = false; //Deactivate after first build of table
				//jQuery fix for autofocus on first input when clicking on popup (the element is actively positioned to mouse cursor height)
				$('#jsonTable-popup').prepend("<button id='DialogAutofocusElement' onclick='event.stopPropagation(); event.preventDefault();' style='position:absolute; top:0px; left:-100000px; opacity:0; width:0px !important; height:0px !important;'></button>"); 
				$(window).on('scroll', function(event){
					$('#DialogAutofocusElement').css('top', ($(window).scrollTop() + $('#jsonTable-popup').offset().top + 20) + 'px');
				});
				$('#jsonTable-popup').on('mousemove', function(event){
					$('#DialogAutofocusElement').css('top', ($(window).scrollTop() + $('#jsonTable-popup').offset().top + 20) + 'px');
				});
				if (popupVisible) setTimeout(function(){ $('.ui-table-columntoggle-btn').click(); }, 100);
				if ((headHideColumntoggleButton || colsSortedAndFiltered.length >= alwaysVisibleCount) && !$('.customCSS_headHideColumntoggleButton').length){					
					addCustomCSS('.ui-table-columntoggle-btn { display: none; }', 'headHideColumntoggleButton');
				} else if ($('.customCSS_headHideColumntoggleButton').length){
					removeCustomCSS('headHideColumntoggleButton');
				}
			} else { //Only update body
				$('#jsonTableContainer tbody').html(bodyString);
				$('#jsonTable').table('refresh').trigger('create');
				$('#jsonTable-popup input[type=checkbox]').trigger('change');
			}
			//Subscribe to datapoints
			for(id in tableDatapoints){
				sendPostMessage("getStateSubscribed", id);
			}
			//Show/Hide Load More Button
			if(!rowsLimitLoadMore || rowsLimit == 0 || dataObject.length <= rowsLimit){
				$('#loadMoreButtonContainer').hide(500);
			} else {
				$('#loadMoreButtonContainer').show(500);
			}
		}
		
		//Update datapoint
		function updateDatapoint(id){
			if (!id) return;
			if (typeof datapointsParentNames[id] != "undefined" && typeof datapointsParentNames[id].childIds != "undefined" && datapointsParentNames[id].childIds.length > 0){ //Is parentName-Datepoint
				datapointsParentNames[id].childIds.forEach(function(childId){
					if(tableDatapoints[childId]){
						if (typeof datapoints[childId] == "undefined") datapoints[childId] = {};
						datapoints[childId].parentName = datapoints[id].name; //parentName
						updateDatapoint(childId);
					}
				});
			}
			if (typeof tableDatapoints[id] == "undefined" || typeof tableDatapoints[id].rows == "undefined" || tableDatapoints[id].rows.length == 0) return;
			tableDatapoints[id].rows.forEach(function(row){
				datapointExtendTableCols.forEach(function(datapointExtendTableCol){
					var result = datapoints[id] && datapoints[id][datapointExtendTableCol];
					if (datapointExtendTableCol == "parentName" && !result) result = datapoints[id].name || id;  //parentName
					if (typeof result == "undefined" || result === null) result = ""; else result = result.toString();
					if (datapointExtendTableCol == "val" && result != "" && datapoints[id].unit) result += (datapoints[id].unit == "%" ? "" : "&nbsp;") + datapoints[id].unit;
					if (datapointExtendTableCol == "plainText" && result != "" && (datapoints[id].val == datapoints[id].plainText) && datapoints[id].unit) result += (datapoints[id].unit == "%" ? "" : "&nbsp;") + datapoints[id].unit;
					result = multiReplace(result, ((iconCols[0] == "" || iconCols.indexOf(datapointExtendTableCol) != -1) ? translationsAndIconReplacements : translations), true);
					$("td[data-row='" + row + "'][data-colname='" + datapointExtendTableCol + "']").html(result);
				});
				datapointToggleCols.forEach(function(datpointToggleCol){
					$("td[data-row='" + row + "'][data-colname='" + datpointToggleCol + "']:not(:has(>span))").each(function(){
						$(this).html("<span class='datapoint-toggle' data-id='" + id + "' style='cursor: pointer;'>" + $(this).html() + "</span>");
					});
				});
			});
			$("span.datapoint-toggle:not(.clickEventBound)").on('click', spanToggleClick).addClass('clickEventBound');
		}
		
		//Toggle datapoint
		function spanToggleClick(){
			var id = $(this).data('id');
			var state = datapoints[id];
			if (state && state.readonly == false){
				switch(state.type){
					case "button":
					var newVal = true;
					break;

					case "level":
					var oldVal = state.val;
					var min = state.min || 0;
					var max = state.max || 100;
					var newVal;
					if (oldVal > min) newVal = min; else newVal = max;
					break;

					case "valueList":
					var oldVal = state.val;
					if (oldVal == true || oldVal.toString().toLowerCase() == "true") oldVal = 1;
					if (oldVal == false || oldVal.toString().toLowerCase() == "false") oldVal = 0;
					var min = state.min || 0;
					if (typeof state.valueList !== "undefined" && oldVal + 1 >= Object.keys(state.valueList).length) var newVal = min; else newVal = oldVal + 1;
					break;

					case "switch": default:
					var oldVal = state.val;
					var newVal;
					if (typeof oldVal == 'number'){
						if (oldVal) newVal = 0; else newVal = 1;
					} else {
						if (oldVal.toString().toLowerCase() == "true") newVal = false; else newVal = true;
					}
				}
				if (typeof newVal !== "undefined") sendPostMessage("setState", id, newVal);
			}
		}

		//create Breakpoints
		function createBreakpoints(numberOfNeededBreakpoints){
			if (breakpointsCount < numberOfNeededBreakpoints){
				if (breakpoints.length < numberOfNeededBreakpoints){
					while(numberOfNeededBreakpoints > breakpoints.length){
						breakpoints.push(((parseInt(breakpoints[breakpoints.length - 1]) || 10) + 10).toString());
					}
				}
				console.log(breakpoints);
				var customCSS = "";
				for(i = 0; i < numberOfNeededBreakpoints; i++){
					//Add breakpoint
					customCSS += ".ui-table-columntoggle th.ui-table-priority-" + (i + 1) + ",";
					customCSS += ".ui-table-columntoggle td.ui-table-priority-" + (i + 1) + " {";
					customCSS += "   display: none;";
					customCSS += "}";
					customCSS += "@media screen and (min-width: " + breakpoints[i] + "em) {";
					customCSS += "   .ui-table-columntoggle th.ui-table-priority-" + (i + 1) + ",";
					customCSS += "   .ui-table-columntoggle td.ui-table-priority-" + (i + 1) + " {";
					customCSS += "     display: table-cell;";
					customCSS += "   }";
					customCSS += "} ";				
				}
				// Manually hidden
				customCSS += ".ui-table-columntoggle th.ui-table-cell-hidden,";
				customCSS += ".ui-table-columntoggle td.ui-table-cell-hidden {";
				customCSS += "  display: none;";
				customCSS += "} ";			 
				// Manually shown
				customCSS += ".ui-table-columntoggle th.ui-table-cell-visible,";
				customCSS += ".ui-table-columntoggle td.ui-table-cell-visible {";
				customCSS += "   display: table-cell;";
				customCSS += "} ";
				removeCustomCSS("breakpoints");
				addCustomCSS(customCSS, "breakpoints");
				breakpointsCount = numberOfNeededBreakpoints;
			}
		}

		//send postMessages
		function sendPostMessage(command, stateId, value){
			message = { command: command, stateId: stateId, value: value };
			window.parent.postMessage(message, "*");
		}

		//receive postMessages
		window.addEventListener("message", receivePostMessage, false);
		function receivePostMessage(event) { //event = {data: message data, origin: url of origin, source: id of sending element}
			if (event.data && event.data.command) switch(event.data.command){
				case "getState":
					if (event.data.stateId) switch(event.data.stateId){
						case getUrlParameter("useThisDatapoint") || "---undefined---":
						console.log("Received USE_THIS_DATAPOINT");
						USE_THIS_DATAPOINT = event.data.value;
						createTable();
						break;

						case "STATE":
						console.log("Received STATE");
						STATE = event.data.value;
						createTable();
						break;

						case "LEVEL":
						console.log("Received LEVEL");
						LEVEL = event.data.value;
						createTable();
						break;
						
						default:
						if (typeof datapoints[event.data.stateId] == "undefined"){
							datapoints[event.data.stateId] = event.data.value;
						} else {
								datapoints[event.data.stateId] = Object.assign({}, datapoints[event.data.stateId], event.data.value);						
						}
						updateDatapoint(event.data.stateId);
					}
				break;
				
				case "getOptions":
				console.log("Received OPTIONS");
				if (event.data.value){
					options = event.data.value;
					handleOptions();
				}
				break;
			}
		}
		
		//GetUrlParameter
		function getUrlParameter(name) {
			name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
			var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
			var results = regex.exec(location.search);
			return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, ' '));
		};

		//tryParseJSON
		function tryParseJSON(jsonString){ //Returns parsed object or false, if jsonString is not valid
			try {
				var o = JSON.parse(jsonString);
				if (o && typeof o === "object") {
					return o;
				}
			}
			catch (e) { }
			return false;
		};
		
		//multiReplace
		function multiReplace(string, replacementObj, onlyExactMatches){ //Replaces multiple replacements in string. replacementObj = [{searchValue: "", newValue: ""}, ...]
			replacementObj.forEach(function(replacement){
				if (onlyExactMatches){
					if (string == replacement.searchValue) string = replacement.newValue;
				} else {
					var regex = new RegExp(replacement.searchValue, "g");
					string = string.toString().replace(regex, replacement.newValue);
				}
			});
			return string;
		}
		
		//Add custom CSS
		function addCustomCSS(customCSS, customID){
			customID = customID || "default";
			$('head').append('<style class="customCSS_' + customID + '">' + customCSS + '</style>');
		}
		
		//Remove custom CSS
		function removeCustomCSS(customID){
			customID = customID || "default";
			$('.customCSS_' + customID).remove();
		}		
	</script>
</body>
</html>